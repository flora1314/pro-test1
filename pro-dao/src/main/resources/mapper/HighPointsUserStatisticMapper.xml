<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.dmall.cem.dao.HighPointsUserStatisticMapper">

	<resultMap id="BaseResultMap" type="com.dmall.cem.domain.PointsHighMemberStatistic">
		<id column="id" property="id" jdbcType="BIGINT" />
		<result column="platform" property="platform" jdbcType="VARCHAR" />
		<result column="used_points" property="usedPoints" jdbcType="BIGINT" />
		<result column="user_id" property="userId" jdbcType="VARCHAR" />
		<result column="user_card_no" property="userCardNo" jdbcType="VARCHAR" />
		<result column="phone" property="phone" jdbcType="VARCHAR" />
		<result column="date" property="date" jdbcType="DATE" />
		<result column="updated" property="updated" jdbcType="TIMESTAMP" />
		<result column="created" property="created" jdbcType="TIMESTAMP" />
		<result column="yn" property="yn" jdbcType="TINYINT" />
	</resultMap>

	<sql id="Base_Column_List">
		`id`,
		`platform`,
		`used_points`,
		`user_id`,
		`user_card_no`,
		`phone`,
		`date`,
		`updated`,
		`created`,
		`yn`
	</sql>

	<select id="selectHignStatistic" resultMap="BaseResultMap" parameterType="com.dmall.cem.domain.PointsHighMemberRequest">
		select
		<include refid="Base_Column_List" />
		<![CDATA[
		from cem_high_points_user_statistic
		WHERE `date`>=#{start} AND `date` <= #{end} AND `used_points`>=#{minPoint} AND `platform` IN
		 ]]>
		<foreach collection="platforms"  item="platform" index="index" separator="," open="(" close=")">
			#{platform}
		</foreach>

		<if test="pageIndex != null and pageSize != null"><![CDATA[ LIMIT #{pageIndex},#{pageSize}]]></if>
	</select>

	<select id="selectCountOfWhere" resultType="java.lang.Integer" parameterType="com.dmall.cem.domain.PointsHighMemberRequest">
		<![CDATA[
		select COUNT(1)
		from cem_high_points_user_statistic
		WHERE `date`>=#{start} AND `date` <= #{end} AND `used_points`>=#{minPoint} AND `platform` IN
		 ]]>
		<foreach collection="platforms"  item="platform" index="index" separator="," open="(" close=")">
			#{platform}
		</foreach>
	</select>

	<select id="selectCountOfDate" resultType="java.lang.Long" parameterType="com.dmall.cem.domain.PointsHighMemberStatistic">
		select COUNT(1)
		from cem_high_points_user_statistic
		WHERE `date` = #{date}
	</select>

	<insert id="insertOnDuplicated" parameterType="com.dmall.cem.domain.PointsHighMemberStatistic">
		INSERT INTO cem_high_points_user_statistic
		(
		`platform`,
		`used_points`,
		`user_id`,
		`user_card_no`,
		`phone`,
		`date`,
		`updated`,
		`created`,
		`yn`)
		VALUES (#{platform},#{usedPoints},#{userId},#{userCardNo},#{phone},#{date},#{updated},#{created},#{yn})
		ON DUPLICATE KEY UPDATE `used_points`=`used_points`+#{usedPoints};
	</insert>
	<delete id="deleteByDate" parameterType="com.dmall.cem.domain.PointsHighMemberStatistic">
		<![CDATA[ DELETE  FROM cem_high_points_user_statistic  WHERE `date` = #{date}]]>
	</delete>
</mapper>